/*! fmd.js v0.3.0 | http://fmdjs.org/ | MIT */
(function(g){if(!g.fmd){var f={},e=[],c=function(b){return f[b]},d=function(b,a,k){if(!f[b]){k||(k=a,a=[]);if("function"===typeof k){for(var d=[],c=0,h=a.length;c<h;c++)d.push(f[a[c]]);k=k.apply(null,d)}f[b]=k||1;e.push(b)}};d.version="@VERSION";d.cache={parts:e};d("global",g);d("require",function(){return c});d("env",function(){return d});d("cache",function(){return d.cache});g.fmd=d}})("undefined"!==typeof window?window:global);
fmd("lang",function(){var g={}.toString,f=Array.prototype,e={isFunction:function(c){return"[object Function]"===g.call(c)},isArray:Array.isArray||function(c){return"[object Array]"===g.call(c)},isString:function(c){return"string"===typeof c},forEach:f.forEach?function(c,d,b){c.forEach(d,b)}:function(c,d,b){for(var a=0,k=c.length;a<k;a++)d.call(b,c[a],a,c)},map:f.map?function(c,d,b){return c.map(d,b)}:function(c,d,b){var a=[];e.forEach(c,function(k,c,e){a.push(d.call(b,k,c,e))});return a},inArray:f.indexOf?
function(c,d){return c.indexOf(d)}:function(c,d){for(var b=0,a=c.length;b<a;b++)if(c[b]===d)return b;return-1}};return e});fmd("event",["env","cache"],function(g,f){var e=f.events={},c=[].slice,d={on:function(b,a){(e[b]||(e[b]=[])).push(a)},emit:function(b){var a=c.call(arguments,1),k=e[b],d,f=0;if(k)for(;d=k[f++];)d.apply(null,a)},off:function(b,a){var k=e[b];if(k)if(a)for(var d=k.length-1;0<=d;d--)k[d]===a&&k.splice(d,1);else delete e[b]}};g.on=d.on;g.emit=d.emit;g.off=d.off;return d});
fmd("config",["env","cache","lang"],function(g,f,e){var c=f.config={},d=f.configRules={},b=0,a={get:function(b){return c[b]},set:function(b){for(var a in b){var f=b[a],h=c[a],g=a,q=f,n=!1,p=void 0,s=void 0;for(s in d)if(n)break;else p=d[s],n=-1<e.inArray(p.keys,g)&&void 0===p.rule.call(c,h,g,q);n||(c[a]=f)}},register:function(a){var c;e.isFunction(a.rule)&&(a.name||(a.name="_rule_"+b++),c=d[a.name]={rule:a.rule,keys:[]});c||(c=d[a.name]);c&&a.keys&&(e.isArray(a.keys)?c.keys=c.keys.concat(a.keys):
c.keys.push(a.keys));return this}};a.register({name:"object",rule:function(a,b,d){if(a)for(var c in d)a[c]=d[c];else return!1}}).register({name:"array",rule:function(a,b,d){a?a.push(d):this[b]=[d]}});g.config=function(b){if(e.isString(b))return a.get(b);a.set(b)};return a});
fmd("module","global env cache lang event config".split(" "),function(g,f,e,c,d,b){var a=[],k=0,m=e.modules={},l={require:function(a){a.require||h.makeRequire(a);d.emit("makeRequire",a.require,a);return a.require},exports:function(a){return a.exports},module:function(a){a.module={id:a.id,exports:a.exports};return a.module}},h=function(a,b,d){this.id=a;this.deps=b||[];this.factory=d;this.exports={};this.unnamed()&&(a="_!_fmd_anonymous_"+k,k++);this.uid=a};h.prototype={unnamed:function(){return""===
this.id},extract:function(){var a=this,b=a.deps,d=[];c.isArray(b)&&c.forEach(b,function(b){var c;(c=l[b])?b=c(a):(a.require||h.makeRequire(a),b=a.require(b));d.push(b)});return d},compile:function(){if(b.get("hasCatch"))try{h.compile(this)}catch(a){d.emit("compileFailed",a,this)}else h.compile(this)},autocompile:function(){this.unnamed()&&this.compile()}};h.get=function(a){return m[a]};h.has=function(a,b){if(l[a])return!0;var c={id:a};b&&d.emit("alias",c);return m[c.id]?!0:!1};h.save=function(a){m[a.uid]=
a;d.emit("saved",a);a.autocompile()};h.require=function(a){var b=h.get(a);if(!b)return d.emit("requireFailed",{id:a}),null;b.compiled||(b.compiled=!0,b.compile());d.emit("required",b);return b.exports};h.makeRequire=function(a){a.require=function(b){b={id:b};d.emit("relative",b,a);d.emit("alias",b);return h.require(b.id)}};h.define=function(b,e,k){var f=arguments.length;1===f?(k=b,b=""):2===f&&(k=e,e=a,c.isString(b)||(e=b,b=""));if(h.has(b,!0))return d.emit("existed",{id:b}),null;h.save(new h(b,e,
k))};h.compile=function(a){if(c.isFunction(a.factory)){var b=a.extract(),b=a.factory.apply(null,b);void 0!==b?a.exports=b:a.module&&a.module.exports&&(a.exports=a.module.exports);a.module&&delete a.module}else void 0!==a.factory&&(a.exports=a.factory);d.emit("compiled",a)};h.define.fmd={};var r=g.define;f.noConflict=function(){g.define=r};f.define=g.define=h.define;return h});
fmd("alias",["config","event"],function(g,f){g.register({keys:"alias",name:"object"});f.on("alias",function(e){var c=g.get("alias"),d;c&&(d=c[e.id])&&(e.id=d)})});
fmd("relative",["lang","event","module"],function(g,f,e){var c=/.*\//,d=/\/\.\//,b=/[^\/]+\/\.\.\//,a={cwd:function(a){return a.match(c)[0]},isDotStart:function(a){return"."===a.charAt(0)},hasSlash:function(a){return 0<a.lastIndexOf("/")},resolve:function(a,c){for(var e=(a+c).replace(d,"/");e.match(b);)e=e.replace(b,"");return e}};f.on("relative",function(b,d){a.isDotStart(b.id)&&d&&a.hasSlash(d.id)&&(d._cwd||(d._cwd=a.cwd(d.id)),b.id=a.resolve(d._cwd,b.id))});return a});
fmd("resolve",["event","config"],function(g,f){f.register({keys:"resolve",name:"array"});g.on("resolve",function(e){var c=f.get("resolve"),d;if(c)for(var b=0,a=c.length;b<a&&(d=c[b](e.id),d===e.id);b++);e.uri=d?d:e.id})});
fmd("id2url",["global","event","config"],function(g,f,e){var c=/^https?:\/\//i,d=(new Date).getTime();e.set({baseUrl:function(){var b=/^\w+\:\/\/[\w\-\.:]+\//i,a=g.document.getElementsByTagName("script"),a=a[a.length-1];return(b=(a=a.hasAttribute?a.src:a.getAttribute("src",4))?a.match(b):null)?b[0]:""}()});e.register({keys:"stamp",name:"object"});f.on("stamp",function(b){var a=e.get("hasStamp")?d:null,c=e.get("stamp");if(c)for(var f in c)if(RegExp(f).test(b.id)){a=c[f];break}a&&(b.url+="?fmd.stamp="+
a)});f.on("id2url",function(b){f.emit("resolve",b);b.url=b.uri;c.test(b.url)||(b.url=e.get("baseUrl")+b.url);var a=b.url;a.lastIndexOf(".")<a.lastIndexOf("/")&&(b.url+=".js");f.emit("stamp",b)});f.on("id2uri",function(b){f.emit("id2url",b);b.uri=b.url})});
fmd("assets",["cache","lang","event","config","module"],function(g,f,e,c,d){var b=g.assets={},a={},k={make:function(c,f){var h={id:c};e.emit("analyze",h);e.emit("relative",h,f);e.emit("alias",h);if(a[h.id])return b[a[h.id]];d.has(h.id)?h.uri=h.id:e.emit("id2uri",h);a[h.id]=h.uri;return b[h.uri]=h},group:function(a){return f.map(a.deps,function(b){return k.make(b,a)})}};return k});
fmd("when",function(){var g=function(){},f=function(e){var c=this,d=[],b=0,a=0;e=e||0;var f=function(){b+a===e&&m()},m=function(){c.then=a?function(a,b){b&&b()}:function(a,b){a&&a()};m=g;l(a?1:0);l=g;d=[]},l=function(a){for(var b,c=0;b=d[c++];)(b=b[a])&&b()};this.then=function(a,b){d.push([a,b])};this.resolve=function(){b++;f()};this.reject=function(){a++;f()};f()};return function(){for(var e=new f(arguments.length),c,d=0;c=arguments[d++];)c(e);return e}});
fmd("request",["global","config","event"],function(g,f,e){var c=g.document,d=g.setTimeout,b=/\.css(?:\?|$)/i,a=/loaded|complete/,k=/security|denied/i,m=/mobile/;g=g.navigator.userAgent.toLowerCase();var l=g.match(/.*webkit\/?(\d+)\..*/),h=(l?536>1*l[1]:!1)||!l&&m.test(g),r=c&&(c.head||c.getElementsByTagName("head")[0]||c.documentElement),q=function(a,b,c){var f=!1,g,h;try{if(g=a.sheet)f=(h=g.cssRules)?0<h.length:void 0!==h}catch(l){f=k.test(l.message)}d(function(){f?(b&&b(),e.emit("requested",c)):
q(a,b,c)},20)},n=function(b,d,c,g,h){function k(){b.onload=b.onreadystatechange=b.onerror=null;h||f.get("debug")||b.parentNode&&b.parentNode.removeChild(b);b=void 0;d&&d()}c?(b.onload=function(){k();e.emit("requested",g)},b.onerror=function(){k();e.emit("requestError",g)}):b.onreadystatechange=function(){a.test(b.readyState)&&(k(),e.emit("requested",g))}},p=function(a,b,c,e){!c||h?d(function(){q(a,b,e)},1):n(a,b,c,e,!0)};return function(a,d){var g=b.test(a.url),h;g?(h=c.createElement("link"),h.rel=
"stylesheet",h.href=a.url):(h=c.createElement("script"),h.async=!0,h.src=a.url);f.get("charset")&&(h.charset=f.get("charset"));e.emit("createNode",h,a);var k="onload"in h;g?p(h,d,k,a):n(h,d,k,a);r.appendChild(h)}});
fmd("loader",["global","event","config","request"],function(g,f,e,c){var d=function(){};e.set({timeout:1E4});f.on("requestComplete",function(b){var a;b.state="loaded";for(a=b.onload;b=a.shift();)b()});return function(b,a){a||(a=d);"loaded"===b.state?a():"loading"===b.state?b.onload.push(a):(b.state="loading",b.onload=[a],f.emit("request",b,a),b.requested||(b.timer=g.setTimeout(function(){f.emit("requestTimeout",b)},e.get("timeout")),c(b,function(){g.clearTimeout(b.timer);f.emit("requestComplete",
b)})))}});
fmd("remote","lang event module assets when loader".split(" "),function(g,f,e,c,d,b){var a={};a.bring=a.get=function(a,c){d.apply(null,g.map(a,function(a){return function(c){e.has(a.id)?c.resolve():b(a,function(){c.resolve()})}})).then(c)};a.fetch=function(b,m){var l=c.group(b);f.emit("fetch",l);a.bring(l,function(){d.apply(null,g.map(l,function(b){return function(c){var d=e.get(b.id);d&&!d.compiled&&d.deps.length?a.fetch(d,function(){c.resolve()}):c.resolve()}})).then(function(){m.call(null,l)})})};
return a});fmd("use",["lang","event","module","remote"],function(g,f,e,c){f.on("makeRequire",function(d,b){d.use=function(a,d){g.isArray(a)||(a=[a]);c.fetch({id:b.id,deps:a},function(a){a=g.map(a,function(a){return e.require(a.id)});d&&d.apply(null,a)})}})});
fmd("async",["config","module","remote"],function(g,f,e){var c=f.prototype.autocompile,d=function(){var b=this;b.unnamed()&&e.fetch(b,function(){b.compile()})};g.register({keys:"async",rule:function(b,a,e){e=!!e;b!==e&&(this.async=e,f.prototype.autocompile=!0===e?d:c)}}).set({async:!0})});
fmd("logger","global require env config assets loader console".split(" "),function(g,f,e,c,d,b,a){var k=e.log=function(){},m=g.console,l=function(c){e.log=c?m&&m.warn?function(a,b){m[b||"log"](a)}:function(c,e){a?a(c,e):b&&b(d.make("fmd/console"),function(){a||(a=f("console"));a(c,e)})}:k};c.register({keys:"debug",rule:function(a,b,c){l(c);this.debug=c}})});
