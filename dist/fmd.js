/*! fmd.js v0.2.6 | http://fmdjs.org/ | MIT */
(function(e){if(!e.fmd){var h={},f=[],c=function(b){return h[b]},d=function(b,a,g){if(!h[b]){g||(g=a,a=[]);if("function"===typeof g){for(var d=[],c=0,e=a.length;c<e;c++)d.push(h[a[c]]);g=g.apply(null,d)}h[b]=g||1;f.push(b)}};d.version="0.2.6";d.cache={parts:f};d("global",e);d("require",function(){return c});d("env",function(){return d});d("cache",function(){return d.cache});e.fmd=d}})(this);
fmd("lang",function(){var e={}.toString,h=Array.prototype,f={isFunction:function(c){return"[object Function]"===e.call(c)},isArray:Array.isArray||function(c){return"[object Array]"===e.call(c)},isString:function(c){return"string"===typeof c},forEach:h.forEach?function(c,d,b){c.forEach(d,b)}:function(c,d,b){for(var a=0,g=c.length;a<g;a++)d.call(b,c[a],a,c)},map:h.map?function(c,d,b){return c.map(d,b)}:function(c,d,b){var a=[];f.forEach(c,function(g,c,f){a.push(d.call(b,g,c,f))});return a},inArray:h.indexOf?
function(c,d){return c.indexOf(d)}:function(c,d){for(var b=0,a=c.length;b<a;b++)if(c[b]===d)return b;return-1}};return f});fmd("event",["env","cache"],function(e,h){var f=h.events={},c=[].slice,d={on:function(b,a){(f[b]||(f[b]=[])).push(a)},emit:function(b){var a=c.call(arguments,1),g=f[b],d,k=0;if(g)for(;d=g[k++];)d.apply(null,a)},off:function(b,a){var g=f[b];if(g)if(a)for(var d=g.length-1;0<=d;d--)g[d]===a&&g.splice(d,1);else delete f[b]}};e.on=d.on;e.off=d.off;return d});
fmd("config",["env","cache","lang"],function(e,h,f){var c=h.config={},d=h.configRules={},b=0,a={get:function(a){return c[a]},set:function(a){for(var b in a){var k=a[b],e=c[b],p=b,h=k,m=!1,n=void 0,s=void 0;for(s in d)if(m)break;else n=d[s],m=-1<f.inArray(n.keys,p)&&void 0===n.rule.call(c,e,p,h);m||(c[b]=k)}},register:function(a){var c;f.isFunction(a.rule)&&(a.name||(a.name="_rule_"+b++),c=d[a.name]={rule:a.rule,keys:[]});c||(c=d[a.name]);c&&a.keys&&(f.isArray(a.keys)?c.keys=c.keys.concat(a.keys):
c.keys.push(a.keys));return this}};a.register({name:"object",rule:function(a,b,d){if(a)for(var c in d)a[c]=d[c];else return!1}}).register({name:"array",rule:function(a,b,d){a?a.push(d):this[b]=[d]}});e.config=function(b){if(f.isString(b))return a.get(b);a.set(b)};return a});
fmd("module",["global","env","cache","lang","event"],function(e,h,f,c,d){var b=[],a=0,g=f.modules={},l={require:function(a){a.require||k.makeRequire(a);d.emit("makeRequire",a.require,a);return a.require},exports:function(a){return a.exports},module:function(a){a.module={id:a.id,exports:a.exports};return a.module}},k=function(b,d,c){this.id=b;this.deps=d||[];this.factory=c;this.exports={};this.unnamed()&&(b="_!_fmd_anonymous_"+a,a++);this.uid=b};k.prototype={unnamed:function(){return""===this.id},
extract:function(){var a=this,b=a.deps,d=[];c.isArray(b)&&c.forEach(b,function(b){var c;(c=l[b])?b=c(a):(a.require||k.makeRequire(a),b=a.require(b));d.push(b)});return d},compile:function(){try{if(c.isFunction(this.factory)){var a=this.extract(),b=this.factory.apply(null,a);void 0!==b?this.exports=b:this.module&&this.module.exports&&(this.exports=this.module.exports);this.module&&delete this.module}else void 0!==this.factory&&(this.exports=this.factory);d.emit("compiled",this)}catch(g){d.emit("compileFailed",
g,this)}},autocompile:function(){this.unnamed()&&this.compile()}};k.get=function(a){return g[a]};k.has=function(a,b){if(l[a])return!0;var c={id:a};b&&d.emit("alias",c);return g[c.id]?!0:!1};k.save=function(a){g[a.uid]=a;d.emit("saved",a);a.autocompile()};k.require=function(a){var b=k.get(a);if(!b)return d.emit("requireFailed",{id:a}),null;b.compiled||(b.compiled=!0,b.compile());d.emit("required",b);return b.exports};k.makeRequire=function(a){a.require=function(b){b={id:b};d.emit("relative",b,a);d.emit("alias",
b);return k.require(b.id)}};k.define=function(a,g,f){var e=arguments.length;1===e?(f=a,a=""):2===e&&(f=g,g=b,c.isString(a)||(g=a,a=""));if(k.has(a,!0))return d.emit("existed",{id:a}),null;k.save(new k(a,g,f))};k.define.fmd={};var q=e.define;h.noConflict=function(){e.define=q};h.define=e.define=k.define;return k});fmd("alias",["config","event"],function(e,h){e.register({keys:"alias",name:"object"});h.on("alias",function(f){var c=e.get("alias"),d;c&&(d=c[f.id])&&(f.id=d)})});
fmd("relative",["lang","event","module"],function(e,h,f){var c=/.*\//,d=/\/\.\//,b=/[^\/]+\/\.\.\//,a={cwd:function(a){return a.match(c)[0]},isDotStart:function(a){return"."===a.charAt(0)},hasSlash:function(a){return 0<a.lastIndexOf("/")},resolve:function(a,c){for(var f=(a+c).replace(d,"/");f.match(b);)f=f.replace(b,"");return f}};h.on("relative",function(b,d){a.isDotStart(b.id)&&(d&&a.hasSlash(d.id))&&(d._cwd||(d._cwd=a.cwd(d.id)),b.id=a.resolve(d._cwd,b.id))});return a});
fmd("id2url",["global","event","config"],function(e,h,f){var c=/^https?:\/\//i,d=(new Date).getTime();f.set({baseUrl:function(){var b=/^\w+\:\/\/[\w\-\.:]+\//i,a=e.document.getElementsByTagName("script"),a=a[a.length-1];return(b=(a=a.hasAttribute?a.src:a.getAttribute("src",4))?a.match(b):null)?b[0]:""}()});f.register({keys:"resolve",name:"array"}).register({keys:"stamp",name:"object"});h.on("resolve",function(b){var a=f.get("resolve"),d;if(a)for(var c=0,e=a.length;c<e&&(d=a[c](b.id),d===b.id);c++);
b.url=d?d:b.id});h.on("stamp",function(b){var a=f.get("hasStamp")?d:null,c=f.get("stamp");if(c)for(var e in c)if(RegExp(e).test(b.id)){a=c[e];break}a&&(b.url+="?fmd.stamp="+a)});h.on("id2url",function(b){h.emit("resolve",b);c.test(b.url)||(b.url=f.get("baseUrl")+b.url);var a=b.url;a.lastIndexOf(".")<a.lastIndexOf("/")&&(b.url+=".js");h.emit("stamp",b)})});
fmd("assets",["cache","lang","event","config","module"],function(e,h,f,c,d){var b=e.assets={},a={},g={make:function(c,e){var g={id:c};f.emit("analyze",g);f.emit("relative",g,e);f.emit("alias",g);if(a[g.id])return b[a[g.id]];d.has(g.id)?g.url=g.id:f.emit("id2url",g);a[g.id]=g.url;return b[g.url]=g},group:function(a){return h.map(a.deps,function(b){return g.make(b,a)})}};return g});
fmd("when",function(){var e=function(){},h=function(f){var c=this,d=[],b=0,a=0;f=f||0;var g=function(){b+a===f&&h()},h=function(){c.then=a?function(a,b){b&&b()}:function(a,b){a&&a()};h=e;k(a?1:0);k=e;d=[]},k=function(a){for(var b,c=0;b=d[c++];)(b=b[a])&&b()};this.then=function(a,b){d.push([a,b])};this.resolve=function(){b++;g()};this.reject=function(){a++;g()};g()};return function(){for(var f=new h(arguments.length),c,d=0;c=arguments[d++];)c(f);return f}});
fmd("request",["global","config","event"],function(e,h,f){var c=e.document,d=e.setTimeout,b=/\.css(?:\?|$)/i,a=/loaded|complete/,g=/security|denied/i,l=/mobile/;e=e.navigator.userAgent.toLowerCase();var k=e.match(/.*webkit\/?(\d+)\..*/),q=(k?536>1*k[1]:!1)||!k&&l.test(e),p=c&&(c.head||c.getElementsByTagName("head")[0]||c.documentElement),r=function(a,b,c){var e=!1,h,k;try{if(h=a.sheet)e=(k=h.cssRules)?0<k.length:void 0!==k}catch(l){e=g.test(l.message)}d(function(){e?(b&&b(),f.emit("requested",c)):
r(a,b,c)},20)},m=function(b,c,d,g,e){function k(){b.onload=b.onreadystatechange=b.onerror=null;e||h.get("debug")||b.parentNode&&b.parentNode.removeChild(b);b=void 0;c&&c()}d?(b.onload=function(){k();f.emit("requested",g)},b.onerror=function(){k();f.emit("requestError",g)}):b.onreadystatechange=function(){a.test(b.readyState)&&(k(),f.emit("requested",g))}},n=function(a,b,c,f){!c||q?d(function(){r(a,b,f)},1):m(a,b,c,f,!0)};return function(a,d){var g=b.test(a.url),e;g?(e=c.createElement("link"),e.rel=
"stylesheet",e.href=a.url):(e=c.createElement("script"),e.async=!0,e.src=a.url);h.get("charset")&&(e.charset=h.get("charset"));f.emit("createNode",e,a);var k="onload"in e;g?n(e,d,k,a):m(e,d,k,a);p.appendChild(e)}});
fmd("loader",["global","event","config","request"],function(e,h,f,c){var d=function(){};f.set({timeout:1E4});h.on("requestComplete",function(b){var a;b.state="loaded";for(a=b.onload;b=a.shift();)b()});return function(b,a){a||(a=d);"loaded"===b.state?a():"loading"===b.state?b.onload.push(a):(b.state="loading",b.onload=[a],h.emit("request",b,a),b.requested||(b.timer=e.setTimeout(function(){h.emit("requestTimeout",b)},f.get("timeout")),c(b,function(){e.clearTimeout(b.timer);h.emit("requestComplete",
b)})))}});
fmd("remote","lang event module assets when loader".split(" "),function(e,h,f,c,d,b){var a={};a.bring=a.get=function(a,c){d.apply(null,e.map(a,function(a){return function(c){f.has(a.id)?c.resolve():b(a,function(){c.resolve()})}})).then(c)};a.fetch=function(b,l){var k=c.group(b);h.emit("fetch",k);a.bring(k,function(){d.apply(null,e.map(k,function(b){return function(c){var d=f.get(b.id);d&&!d.compiled&&d.deps.length?a.fetch(d,function(){c.resolve()}):c.resolve()}})).then(function(){l.call(null,k)})})};
return a});fmd("use",["lang","event","module","remote"],function(e,h,f,c){h.on("makeRequire",function(d,b){d.use=function(a,d){e.isArray(a)||(a=[a]);c.fetch({id:b.id,deps:a},function(a){a=e.map(a,function(a){return f.require(a.id)});d&&d.apply(null,a)})}})});
fmd("async",["config","module","remote"],function(e,h,f){var c=h.prototype.autocompile,d=function(){var b=this;b.unnamed()&&f.fetch(b,function(){b.compile()})};e.register({keys:"async",rule:function(b,a,e){e=!!e;b!==e&&(this.async=e,h.prototype.autocompile=!0===e?d:c)}}).set({async:!0})});
fmd("logger","global require env config assets loader console".split(" "),function(e,h,f,c,d,b,a){var g=f.log=function(){},l=e.console,k=function(c){f.log=c?l&&l.warn?function(a,b){l[b||"log"](a)}:function(c,e){a?a(c,e):b&&b(d.make("fmd/console"),function(){a||(a=h("console"));a(c,e)})}:g};c.register({keys:"debug",rule:function(a,b,c){k(c);this.debug=c}})});
